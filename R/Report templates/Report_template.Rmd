---
title: "`r params$report_name` Break-Up Report `r lubridate::year(Sys.Date())`"
subtitle: " <br><br>"
date: "Prepared on `r Sys.Date()`"
output: 
  word_document:
      reference_docx: style_template.docx
      toc: true
      toc_depth: 2
params:
  stations: stations
  report_name: report_name
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyhydat)
library(tidyhydat.ws)
source("../Hydrometric_Level_mASL.R")
source("../Hydrometric_Flow.R")
```

\newpage

This report is generated by the Yukon Government based on data pulled from the [Real-Time Hydrometric Data](https://wateroffice.ec.gc.ca/mainmenu/real_time_data_index_e.html) published by the Government of Canada. This report is based on data downloaded at `r .POSIXct(Sys.time(), tz="America/Whitehorse")` Yukon time.

# Current Status and Observations

[Enter update here]

\newpage

# Station data

Water level and flow data is listed below in order of historical relative importance to flooding.

In the future, the order of listing could depend instead on which stations is highest in relation to historical levels.

```{r Generate reports, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6.5, results='asis'}

for(i in stations) {
  tryCatch ( {
    station_info <- tidyhydat::hy_stations(i)
    
    #Get the level and flow data
    levelData <- level_data(
      station_number = i,
      extract_realtime = TRUE,
      select_years = lubridate::year(Sys.Date()))
    flowData <- flow_data(
      station_number = i,
      extract_realtime = TRUE,
      select_years = lubridate::year(Sys.Date()))
    
    #Level data processing
    startYearLevel <- min(lubridate::year(levelData[[1]]$Date), na.rm = T)
    todayLevel <- levelData[[3]]$Value[levelData[[3]]$Date==Sys.Date()]
    todayLevelPerc <- round(levelData[[3]]$prctile[levelData[[3]]$Date==Sys.Date()],2)
    yesterdayLevel <- levelData[[3]]$Value[levelData[[3]]$Date==(Sys.Date()-1)]
    cat(" \n## ", tidyhydat::hy_stations(i)$STATION_NAME," (Station ", i, ")  \n")
    cat("### Level")
    #Level data plotting
    levelPlot <- level_plot(
      station_number = i,
      complete_year = levelData[[2]],
      plot_years_df = levelData[[3]],
      dummy_year_df = levelData[[4]],
    )
    print(levelPlot)
    cat("  \n The current level is ", round(todayLevel,3)," meters above sea level which corresponds to the ", todayLevelPerc, " percentile of historic levels for this station. Since yesterday, the level has ", ifelse(todayLevel<yesterdayLevel, "decreased", "increased"), " by ", round(abs(todayLevel-yesterdayLevel), 3)," meters.  \n")
    cat("  \n")
    
    #Flow data processing
    startYearFlow <- min(lubridate::year(flowData[[1]]$Date), na.rm = T)
    todayFlow <- flowData[[3]]$Value[flowData[[3]]$Date==Sys.Date()]
    todayFlowPerc <- round(flowData[[3]]$prctile[flowData[[3]]$Date==Sys.Date()],2)
    yesterdayFlow <- flowData[[3]]$Value[flowData[[3]]$Date==(Sys.Date()-1)]
    cat("### Flow")
    #Flow data plotting
    flowPlot <- flow_plot(
      station_number = i,
      complete_year = flowData[[2]],
      plot_years_df = flowData[[3]],
      dummy_year_df = flowData[[4]],
    )
    print(flowPlot)
    cat("  \n The current flow rate is ", round(todayFlow,3)," cubic meters per second which corresponds to the ", todayFlowPerc, " percentile of historic flow volume for this station. Since yesterday, the level has ", ifelse(todayFlow<yesterdayFlow, "decreased", "increased"), " by ", round(abs(todayFlow-yesterdayFlow), 3)," cubic meters per second.  \n\n")
  
    cat("  \n This station is located in ", station_info$PROV_TERR_STATE_LOC, " at longitude ", round(station_info$LONGITUDE, 2), ", latitude ", round(station_info$LATITUDE,2), ". Level data collection began in ", startYearLevel, " and flow data collection began in ", startYearFlow, ". The historic level data are ", spatstat.utils::percentage(sum(stats::complete.cases(levelData[[1]]))/nrow(levelData[[1]])), " and the historic flow data are ", spatstat.utils::percentage(sum(stats::complete.cases(flowData[[1]]))/nrow(flowData[[1]])), " complete.  \n")
    
    cat("\n\n\\pagebreak\n")
  }, error = function(e) {})
}
```

# Weather Forecast and Products

```{r}

```

# Still Images

```{r}

```

## Other images

```{r}

```

---
title: "`r paste0(params$report_name, lubridate::year(Sys.Date()))`"
subtitle: " <br>"
date: "Prepared on `r Sys.Date()`"
output: 
  word_document:
      reference_docx: style_template.docx
      toc: true
      toc_depth: 2
params:
  stations: stations
  report_name: report_name
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyhydat)
library(tidyhydat.ws)
source("../Levels_with_returns.R")
source("../Hydrometric_Flow.R")
```

\newpage

This report is generated by the Yukon Government based on data pulled from the [Real-Time Hydrometric Data](https://wateroffice.ec.gc.ca/mainmenu/real_time_data_index_e.html) published by the Government of Canada. This report is based on data downloaded at `r .POSIXct(Sys.time(), tz="America/Whitehorse")` Yukon time.

<br>

<br>

# Current Status and Observations

[Enter update here]

\newpage

# Station data

Water level and flow data is listed below in order of historical relative importance to flooding.

In the future, the order of listing could depend instead on which stations is highest in relation to historical levels.

\newpage

```{r Generate reports, echo=FALSE, fig.height=4, fig.width=7, message=FALSE, warning=FALSE, results='asis'}

for(i in stations) {
  
  tryCatch ( {
    station_info <- tidyhydat::hy_stations(i)
    cat(" \n## ", station_info$STATION_NAME," (Station ", i, ")  \n")

    tryCatch ({
      #Get the level data
      levelData <- level_data(
        station_number = i,
        extract_realtime = TRUE,
        select_years = lubridate::year(Sys.Date()))
      
      #Level data processing
      startYearLevel <- min(lubridate::year(levelData[[1]]$Date), na.rm = T)
      todayLevel <- levelData[[3]]$Value[levelData[[3]]$Date==Sys.Date()]
      todayLevelPerc <- round(levelData[[3]]$prctile[levelData[[3]]$Date==Sys.Date()],2)
      yesterdayLevel <- levelData[[3]]$Value[levelData[[3]]$Date==(Sys.Date()-1)]
      
      cat("### Level")
      cat("\n")
      #Level data plotting
      levelPlot <- level_plot(station_number = i,
                              complete_year = levelData[[2]],
                              plot_years_df = levelData[[3]],
                              dummy_year_df = levelData[[4]])
      print(levelPlot)
      
      cat("  \n The current level is ", round(todayLevel,2)," meters above sea level which corresponds to the ", todayLevelPerc, " percentile of historic levels for this station. Since yesterday, the level has ", ifelse(todayLevel<yesterdayLevel, "decreased", "increased"), " by ", round(abs(todayLevel-yesterdayLevel), 3)," meters.  \n")
    },
    error=function(e) {
      cat("### Level")
      cat("  \n Station ", i, " does not appear to have real-time level data right now.  \n")})
    
    cat("  \n")
    
    if (stringr::str_detect(station_info$STATION_NAME, "LAKE")==FALSE){ #Lakes don't have flow measurements!
      tryCatch ({
      #Get the flow data
      flowData <- flow_data(
        station_number = i,
        extract_realtime = TRUE,
        select_years = lubridate::year(Sys.Date()))
      #Flow data processing
      startYearFlow <- min(lubridate::year(flowData[[1]]$Date), na.rm = T)
      todayFlow <- flowData[[3]]$Value[flowData[[3]]$Date==Sys.Date()]
      todayFlowPerc <- round(flowData[[3]]$prctile[flowData[[3]]$Date==Sys.Date()],2)
      yesterdayFlow <- flowData[[3]]$Value[flowData[[3]]$Date==(Sys.Date()-1)]
      cat("### Flow")
      cat("\n")
      #Flow data plotting
      flowPlot <- flow_plot(station_number = i,
                            complete_year = flowData[[2]],
                            plot_years_df = flowData[[3]],
                            dummy_year_df = flowData[[4]])
      print(flowPlot)
      
      cat("  \n The current flow rate is ", round(todayFlow,2)," cubic meters per second which corresponds to the ", todayFlowPerc, " percentile of historic flow volume for this station. Since yesterday, the level has ", ifelse(todayFlow<yesterdayFlow, "decreased", "increased"), " by ", round(abs(todayFlow-yesterdayFlow), 3)," cubic meters per second.")
    },
      error = function(e) {
      cat("### Flow")
      cat("  \n Station ", i, " does not appear to have real-time flow (discharge) data right now.")})
    } #End of if statement that is "LAKE" dependent
    
    #line break to separate things out
  cat(" 
      <br>
      
      <br>
      ") 
  
  #Level and flow plots are done by this point, now summarize station information.
  cat("\n This station is located in ", station_info$PROV_TERR_STATE_LOC, " at longitude ", round(station_info$LONGITUDE, 2), ", latitude ", round(station_info$LATITUDE,2), ". Level data collection began in ", startYearLevel, " and flow data collection began in ", startYearFlow, ". The historic level data are ", spatstat.utils::percentage(sum(stats::complete.cases(levelData[[1]]))/nrow(levelData[[1]])), " complete and the historic flow data are ", spatstat.utils::percentage(sum(stats::complete.cases(flowData[[1]]))/nrow(flowData[[1]])), " complete.  \n")
    
  cat("\\pagebreak\n")
  }, 
  
  error= function(e) {
    cat(" \n## ", tidyhydat::hy_stations(i)$STATION_NAME, " (Station ", i, ")")
    cat("  \n Station ", i, " could not be found in the WSC tidyhydat database.")})
}
```

# Weather Forecasts and Products

```{r}
#This section will generate weather products depending on the station locations(s). For example, Marsh Lake would get a forecast for Whitehorse and weather products for southern lakes.

```

# Still Images

```{r}
#This section will contain auto-generated images, selected based on the stations(s) selected. This section might exist only for the pre-made reports and not the custom reports, tbd.
```

## Other images

```{r}

```
